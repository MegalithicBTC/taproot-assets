<!doctype html>
<html lang="en">
<body>
<script type="module">
    // Code from https://github.com/bjorn3/browser_wasi_shim.
    import { WASI, File, OpenFile, ConsoleStdout } from "./polyfill/index.js";
    let args = [];
    let env = [""];
    let fds = [
        new OpenFile(new File([])), // stdin,
        ConsoleStdout.lineBuffered(msg => {
            console.log(`[WASI stdout] ${msg}`)
            document.getElementById("output").textContent += `${msg}\n`;
        }),
        ConsoleStdout.lineBuffered(msg => console.warn(`[WASI stderr] ${msg}`)),
    ];

    let wasm = await WebAssembly.compileStreaming(fetch("tap.wasm"));
    let wasi = new WASI(args, env, fds, {debug: true});
    
    document.send = async function() {
        let start = new Date().getTime();
        console.log("Start at " + start);
        let input = document.getElementById("input").value;

        wasi.args = input.split(" ");
        let inst = await WebAssembly.instantiate(wasm, {
            "wasi_snapshot_preview1": wasi.wasiImport,
        });

        wasi.start(inst);

        let end = new Date().getTime();
        console.log("End at " + end + " (diff: " + (end - start) + "ms)");
    }
</script>
<input type="text" id="input" size="50" value='testrpc.Test.SayHello {"name":"Oli"}'/>
<input type="button" value="Send" onclick="send()"/><br/>
<pre id="output"></pre>
</body>
</html>
